# API仕様

## APIの概要

```src/service/api/VolumeShapeGenerator.ts```ファイルの関数を利用し
容積値とGLBファイルの取得、Babylon.jsのScene上のObjectを破棄を行うことができます。

- 容積値とGLBの取得は```getVolumeShapesData```関数を利用します。
- Babylon.jsのScene上のObjectを破棄する場合は```disposeObject```関数を利用します。

## APIの処理の流れ

### getVolumeShapesData関数

関数の引数に渡すデータを用意します。

- 建築可能な建物の最大ボリュームと既存建築物の差分のモデル生成に必要な建物情報のJSONを用意します。
  - JSON作成に関しては「生成条件を指定したボリューム生成」のページの「3Dモデルデータ生成に必要な情報」の章を参照ください。
- Babylon.js上で3Dモデルの加工処理を行うため、Babylon.jsのSceneを生成します。

関数を実行します。

- ```src/service/api/VolumeShapeGenerator.ts```の```getVolumeShapesData```関数を実行します。
    - 建物情報のJSONテキスト、```Babylon.js```の```Scene```、容積計算の詳細値、その他、取得するGLBファイルのPrefixやテストモードフラグのパラメータを引数として入力します。
      - 容積計算の詳細値、取得するGLBファイルのPrefix、テストモードフラグにはデフォルト値が割り当てられていますので入力しなくても実行可能です。
      - 容積計算の詳細値は容積の精度に関わります。値が小さい程詳細な計算を行いますが処理時間に影響します。

APIは実行されると以下の処理を行います。

1: 建築可能な建物の最大ボリュームの3Dモデルデータ生成を開始します。

- 建物形状のモデルデータを生成します。生成するモデルの高さは地域の高さ制限の値にします。
- 各種条件に従い、ブーリアン処理を行うためのモデルを作成し、既に生成した建物モデル対して減算処理を行います。
    - 隣地斜線制限に従いブーリアン処理を行うためのモデルを作成し、同様に減算処理を続けていきます。
    - 道路斜線制限に従い、同様に減算処理を続けていきます。
    - 「階高の各フロア面積合計 ÷ 敷地面積 が 容積率以下」となる条件の最大の高さを算出し、その高さ以上を減算処理で削ります。

以上の処理で、建築可能な建物の最大ボリュームの生成が完了します。

2: 容積形状の体積計算とGLBの作成を行います。

- 建築可能な建物の最大ボリュームのモデルをGLBとして書き出します
- 建築可能な建物の最大ボリュームの容積を取得します。
    - 容積は積層の面積 x 積層の間隔となる```volumeCalcDetailVal```の値で求め算出します。
- 建築可能な建物の最大ボリュームと既存建築物の差分データの取得に取りかかります。
    - 元のビルの高さの情報に従い、その高さ以下を減算処理で削ります。このモデルが建築可能な建物の最大ボリュームと既存建築物の差分になります。
    - 差分のモデルの容積を取得し、GLBを書き出します。
    - 最大ボリュームの容積 - 残ったモデルの容積 で建築可能な建物の最大ボリュームと既存建築物の差分
    - 元のビルの高さ以下のモデルも生成し、容積の取得とGLB書き出しを行います。

取得した各容積値とGLBをAPI実行の結果として返します。

### disposeObject関数

Babylon.jsのScene上のObjectを破棄します。

- 第一引数にBABYLON.Sceneを入れます。
- 破棄しないObjectがある場合は第二引数のstring配列にObject名を入れます。